<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>وحداتنا - بروز القمة العقارية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
</head>
<body>
    <!-- Hamburger Dropdown Menu -->
    <div class="hamburger-dropdown" id="hamburgerDropdown">
        <div class="hamburger-dropdown-content">
            <button class="close-menu" id="closeMenu" aria-label="إغلاق">
                ×
            </button>
            <ul class="hamburger-menu-list">
                <li>
                    <a href="/" class="hamburger-menu-link">
                        <span>الرئيسية</span>
                    </a>
                </li>
                <li>
                    <a href="/#about" class="hamburger-menu-link">
                        <span>من نحن</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'units:services' %}" class="hamburger-menu-link">
                        <span>خدماتنا</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'units:units' %}" class="hamburger-menu-link">
                        <span>استكشف الوحدات</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'units:policy' %}" class="hamburger-menu-link">
                        <span>سياسة التشغيل</span>
                    </a>
                </li>
                {% if user.is_authenticated %}
                <li>
                    <form action="{% url 'units:logout' %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="hamburger-menu-link" style="background:none;border:0;padding:0;">
                            <span>تسجيل الخروج</span>
                        </button>
                    </form>
                </li>
                {% else %}
                <li>
                    <a href="{% url 'units:login' %}" class="hamburger-menu-link">
                        <span>تسجيل الدخول</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- Hero Section for Units -->
    <section id="home" class="hero-section hero-section-short" style="background: linear-gradient(135deg, rgba(45, 52, 54, 0.98) 0%, rgba(99, 110, 114, 0.95) 30%, rgba(139, 119, 101, 0.95) 70%, rgba(168, 144, 120, 0.98) 100%);">
        <!-- خلفية بدون صورة: تدرج مطابق للفوتر -->
        
        <!-- Navigation -->
        <nav class="navbar navbar-light">
            <div class="container">
                <!-- Logo - أقصى اليمين -->
                <a class="navbar-brand" href="/">
                    <div class="logo-container">
                        <img src="{% static 'images/logop.png' %}" alt="بروز القمة العقارية" class="brand-logo">
                    </div>
                </a>
                
                <!-- Left Section - جميع الخانات في اليسار -->
                <div class="navbar-left-section">
                    <!-- Hamburger Menu Button -->
                    <button class="hamburger-menu" id="hamburgerMenu" aria-label="القائمة">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                </div>
            </div>
        </nav>
        
        <div class="hero-overlay"></div>
        <div class="container">
            <div class="row align-items-center" style="min-height: 50vh;">
                <div class="col-lg-8 mx-auto text-center">
                    <div class="hero-content" style="margin-top: 90px;">
                        <h1 class="hero-title" data-aos="fade-up" data-aos-duration="1000" style="font-size: clamp(1.25rem, 3.2vw, 1.9rem); margin-bottom: 12px;">أهلًا وسهلًا {{ user.get_full_name|default:user.username }}</h1>
                        <div data-aos="fade-up" data-aos-duration="1000" data-aos-delay="180" style="max-width: 820px; margin: 0 auto;">
                            <p class="hero-description" style="font-size: clamp(0.95rem, 2.4vw, 1.1rem); margin-bottom: 8px;">معك وبك نسير بخُطى راسخة نحو بروز القمّة، بإذن الله تعالى.</p>
                            <p class="hero-description" style="font-size: clamp(0.95rem, 2.3vw, 1.05rem); margin-bottom: 8px;">﴿ وَمَا تَوْفِيقِي إِلَّا بِاللَّهِ عَلَيْهِ تَوَكَّلْتُ وَإِلَيْهِ أُنِيبُ ﴾</p>
                            <p class="hero-description" style="font-size: clamp(0.95rem, 2.3vw, 1.05rem);">زادك الله بركةً في خطاك ورزقًا واسعًا حيثما اتجهت</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Units Section (Centered, no tabs) -->
    <section id="units" class="units-section py-5">
        <div class="container">
            <!-- Quick action cards: Bookings, Reports, Contracts -->
            <div class="row g-4 justify-content-center mb-4">
                <!-- Bookings Card -->
                <div class="col-lg-4 col-md-6">
                    <div class="unit-card" style="cursor: default; position: relative;">
                        <!-- Badge: إجمالي الحجوزات بالـ SR داخل كارد الحجوزات أعلى اليسار -->
                        <span id="bookingTotalBadge" title="إجمالي الحجوزات"
                              style="position:absolute; top:10px; left:10px; display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; background: linear-gradient(135deg, #a89078 0%, #8b7765 100%); color:#fff; border-radius:999px; font-weight:700; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:66px; z-index:2;">
                            0 SR
                        </span>
                        <div class="unit-content">
                            <h5>الحجوزات</h5>
                            {% if units %}
                            <div class="mb-2">
                                <label class="form-label">اختر الوحدة</label>
                                <select class="form-select" id="bookingUnitSelect">
                                    {% for unit in units %}
                                    <option value="{{ unit.id }}" data-owner="{% if unit.owner_id == user.id %}true{% else %}false{% endif %}">{{ unit.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button id="openCalendarBtn" class="btn w-100" style="background: linear-gradient(135deg, #a89078 0%, #8b7765 100%); color: white; border: none;">عرض التقويم</button>
                            {% else %}
                            <div class="text-muted">لا توجد وحدات لعرض الحجوزات</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Reports Card -->
                <div class="col-lg-4 col-md-6">
                    <div class="unit-card" style="cursor: default;">
                        <div class="unit-content">
                            <h5>التقارير (PDF)</h5>
                            {% if reports %}
                            <ul class="list-group list-group-flush">
                                {% for r in reports|slice:':5' %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 70%;">{{ r.title }}</span>
                                    <span>
                                        <a href="{{ r.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">عرض</a>
                                        <a href="{{ r.file.url }}" class="btn btn-sm btn-primary" download>تحميل</a>
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-muted">لا توجد تقارير</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Contracts Card -->
                <div class="col-lg-4 col-md-6">
                    <div class="unit-card" style="cursor: default;">
                        <div class="unit-content">
                            <h5>العقود (PDF)</h5>
                            {% if contracts %}
                            <ul class="list-group list-group-flush">
                                {% for c in contracts|slice:':5' %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 70%;">{{ c.title }}</span>
                                    <span>
                                        <a href="{{ c.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">عرض</a>
                                        <a href="{{ c.file.url }}" class="btn btn-sm btn-primary" download>تحميل</a>
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-muted">لا توجد عقود</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
            
            
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-main py-5">
            <div class="container">
                <div class="row g-4" data-aos="fade-up" data-aos-duration="1000">
                    <!-- Company Info -->
                    <div class="col-lg-4 col-md-6">
                        <div class="footer-section">
                            <div class="footer-logo mb-4">
                                <img src="{% static 'images/logop.png' %}" alt="بروز القمة العقارية" class="footer-brand-logo">
                            </div>
                            <p class="footer-description">
                                بروز القمة العقارية - شريكك الموثوق في إدارة وتشغيل العقارات. نسعى لتحقيق أعلى معايير الجودة والكفاءة في خدماتنا.
                            </p>
                            <div class="footer-social-links mt-4">
                                <a href="https://wa.me/966502570316" class="footer-social-link" target="_blank">
                                    واتساب
                                </a>
                                <a href="https://www.instagram.com/brooz.co2017" class="footer-social-link" target="_blank">
                                    انستقرام
                                </a>
                                <a href="https://www.tiktok.com/@brooz.co2017" class="footer-social-link" target="_blank">
                                    تيك توك
                                </a>
                                <a href="https://snapchat.com/t/FwbRGveN" class="footer-social-link" target="_blank">
                                    سناب شات
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="col-lg-2 col-md-6">
                        <div class="footer-section">
                            <h5 class="footer-heading">روابط سريعة</h5>
                            <ul class="footer-links">
                                <li><a href="/">الرئيسية</a></li>
                                <li><a href="/#about">من نحن</a></li>
                                <li><a href="{% url 'units:services' %}">خدماتنا</a></li>
                                <li><a href="{% url 'units:units' %}">وحداتنا</a></li>
                                <li><a href="{% url 'units:policy' %}">سياسة التشغيل</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Services -->
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-section">
                            <h5 class="footer-heading">خدماتنا</h5>
                            <ul class="footer-links">
                                <li><a href="{% url 'units:services' %}">إدارة العقارات</a></li>
                                <li><a href="{% url 'units:services' %}">التسويق العقاري</a></li>
                                <li><a href="{% url 'units:services' %}">الصيانة والخدمات</a></li>
                                <li><a href="{% url 'units:services' %}">الإدارة المالية</a></li>
                                <li><a href="{% url 'units:services' %}">التقارير الشهرية</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Contact Info -->
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-section">
                            <h5 class="footer-heading">معلومات التواصل</h5>
                            <ul class="footer-contact">
                                <li>
                                    <a href="tel:+966502570316">+966 50 257 0316</a>
                                </li>
                                <li>
                                    <a href="mailto:brooz.co2017@gmail.com">brooz.co2017@gmail.com</a>
                                </li>
                                <li>
                                    <span>الرياض - السعودية</span>
                                </li>
                                <li>
                                    <span>خدمة 24/7</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer Bottom -->
        <div class="footer-bottom py-3">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-end">
                        <p class="footer-copyright mb-0">
                            © 2025 بروز القمة العقارية. جميع الحقوق محفوظة
                        </p>
                    </div>
                    <div class="col-md-6 text-center text-md-start">
                        <div class="footer-bottom-links">
                            <a href="#privacy">سياسة الخصوصية</a>
                            <span class="separator">●</span>
                            <a href="#terms">الشروط والأحكام</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS Animation Library -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            easing: 'ease-in-out',
            once: true,
            mirror: false,
            offset: 100,
        });
    </script>
    <script src="{% static 'js/script.js' %}"></script>
    
    <!-- Modal for Unit Calendar -->
    <div class="modal fade" id="unitModal" tabindex="-1" aria-labelledby="unitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(45, 52, 54, 0.98) 0%, rgba(99, 110, 114, 0.95) 30%, rgba(139, 119, 101, 0.95) 70%, rgba(168, 144, 120, 0.98) 100%); color: white;">
                    <h5 class="modal-title" id="unitModalLabel" style="color: white;">تقويم الحجوزات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div id="calendar-container" style="width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendar Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isStaff = {{ user.is_staff|yesno:"true,false" }};
            const unitCards = document.querySelectorAll('.unit-card[data-unit-id]');
            const modalEl = document.getElementById('unitModal');
            const modal = new bootstrap.Modal(modalEl);
            // تأكيد عمل زر الإغلاق حتى لو تعطل سلوك data-bs-dismiss في بعض البيئات
            const closeBtn = modalEl.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.hide());
            }
            let currentUnitId = null;
            let currentDisplayMonth = new Date().getMonth();
            let currentDisplayYear = new Date().getFullYear();
            let calendarEvents = [];
            let isMobile = window.innerWidth <= 576;
            const totalBadge = document.getElementById('bookingTotalBadge');
            let isOwnerForCurrentUnit = false;
            
            unitCards.forEach(card => {
                card.addEventListener('click', function() {
                    const unitId = this.dataset.unitId;
                    currentUnitId = unitId;
                    const unitName = this.querySelector('h5').textContent;
                    
                    document.getElementById('unitModalLabel').textContent = `تقويم الحجوزات - ${unitName}`;
                    
                    // جلب بيانات الحجوزات
                    // إعادة تعيين الشهر والسنة الحاليين عند فتح التقويم
                    const today = new Date();
                    currentDisplayMonth = today.getMonth();
                    currentDisplayYear = today.getFullYear();
                    
                    fetch(`/api/unit/${unitId}/bookings/`)
                        .then(response => response.json())
                        .then(data => {
                            displayCalendar(data.events);
                            modal.show();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('حدث خطأ في تحميل البيانات');
                        });
                });
            });

            // Open calendar from the bookings card
            const openCalendarBtn = document.getElementById('openCalendarBtn');
            const bookingUnitSelect = document.getElementById('bookingUnitSelect');
            if (openCalendarBtn && bookingUnitSelect) {
                openCalendarBtn.addEventListener('click', function() {
                    const unitId = bookingUnitSelect.value;
                    const selectedOpt = bookingUnitSelect.options[bookingUnitSelect.selectedIndex];
                    const unitName = selectedOpt?.text || '';
                    isOwnerForCurrentUnit = (selectedOpt?.dataset?.owner === 'true');
                    currentUnitId = unitId;
                    document.getElementById('unitModalLabel').textContent = `تقويم الحجوزات - ${unitName}`;
                    // إعادة تعيين الشهر والسنة الحاليين عند فتح التقويم
                    const today = new Date();
                    currentDisplayMonth = today.getMonth();
                    currentDisplayYear = today.getFullYear();
                    
                    fetch(`/api/unit/${unitId}/bookings/`)
                        .then(r => r.json())
                        .then(d => { displayCalendar(d.events); modal.show(); })
                        .catch(() => alert('حدث خطأ في تحميل البيانات'));
                });
            }
            
            // زر التحديث لإعادة تحميل الحجوزات فوراً
            const header = modalEl.querySelector('.modal-header');
            if (!header.querySelector('.refresh-calendar')) {
                const refreshBtn = document.createElement('button');
                refreshBtn.type = 'button';
                refreshBtn.className = 'btn refresh-calendar';
                refreshBtn.textContent = 'تحديث التقويم';
                refreshBtn.style.marginInlineStart = 'auto';
                refreshBtn.style.background = 'linear-gradient(135deg, #a89078 0%, #8b7765 100%)';
                refreshBtn.style.color = 'white';
                refreshBtn.style.border = 'none';
                refreshBtn.addEventListener('click', () => {
                    if (!currentUnitId) return;
                    fetch(`/api/unit/${currentUnitId}/bookings/`)
                        .then(r => r.json())
                        .then(d => {
                            displayCalendar(d.events);
                        })
                        .catch(() => alert('تعذر تحديث التقويم'));
                });
                header.appendChild(refreshBtn);
            }

            function displayCalendar(events) {
                calendarEvents = events; // حفظ الأحداث للاستخدام عند التنقل
                updateBookingTotalBadge(calendarEvents);
                renderCalendarMonth();
            }

            function updateBookingTotalBadge(events) {
                if (!totalBadge) return;
                let sum = 0;
                for (const e of events || []) {
                    if (e && e.price != null && !isNaN(parseFloat(String(e.price).toString().replace(/,/g, '')))) {
                        sum += parseFloat(String(e.price).toString().replace(/,/g, ''));
                    }
                }
                const display = Math.round(sum).toLocaleString('en-US');
                totalBadge.textContent = `${display} SR`;
            }

            function renderCalendarMonth() {
                const container = document.getElementById('calendar-container');
                const today = new Date();
                // قياسات متجاوبة حسب الشاشة (تصغير كافٍ لإظهار الشهر كاملًا بدون سكرول)
                const cellMinHeight = isMobile ? 44 : 60;
                const headerFontSize = isMobile ? 16 : 20;
                const dayFontSize = isMobile ? 12 : 14;
                const gridGap = isMobile ? 4 : 6;
                const padXY = isMobile ? '4px 6px' : '6px 8px';
                
                // تحويل الأحداث إلى خريطة للوصول السريع بحسب التاريخ
                const eventMap = new Map();
                calendarEvents.forEach(e => {
                    eventMap.set(e.date, e);
                });
                
                const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                const weekDays = isMobile ? ['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'] : ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                
                const month = currentDisplayMonth;
                const year = currentDisplayYear;
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const isCurrentMonth = (month === today.getMonth() && year === today.getFullYear());
                
                // حساب الشهر السابق والتالي
                let prevMonth = month - 1;
                let prevYear = year;
                if (prevMonth < 0) {
                    prevMonth = 11;
                    prevYear = year - 1;
                }
                
                let nextMonth = month + 1;
                let nextYear = year;
                if (nextMonth > 11) {
                    nextMonth = 0;
                    nextYear = year + 1;
                }
                
                let html = '';
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(45, 52, 54, 0.98) 0%, rgba(99, 110, 114, 0.95) 30%, rgba(139, 119, 101, 0.95) 70%, rgba(168, 144, 120, 0.98) 100%); border-radius: 10px; margin-bottom: 12px; gap: 10px; flex-wrap: wrap;">';
                html += '<button id="prevMonthBtn" class="btn" style="min-width: 84px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s; font-size:' + (isMobile? '14px':'14px') + ';"><i class="fas fa-chevron-right" style="color: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));"></i> السابق</button>';
                html += '<div style="flex: 1; text-align: center;"><h3 style="margin: 0; color: white; font-weight: 700; font-size: ' + headerFontSize + 'px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">' + monthNames[month] + ' ' + year + '</h3></div>';
                html += '<button id="nextMonthBtn" class="btn" style="min-width: 84px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s; font-size:' + (isMobile? '14px':'14px') + ';">التالي <i class="fas fa-chevron-left" style="color: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));"></i></button>';
                html += '</div>';
                if (!isCurrentMonth) {
                    html += '<div style="text-align: center; margin-bottom: 10px;"><button id="goToTodayBtn" class="btn" style="padding: 8px 20px; background: linear-gradient(135deg, #a89078 0%, #8b7765 100%); color: white; border: none; transition: all 0.3s; box-shadow: 0 2px 8px rgba(168, 144, 120, 0.3);"><i class="fas fa-calendar-day" style="color: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));"></i> الذهاب إلى الشهر الحالي</button></div>';
                }
                html += '</div>';
                
                html += `<div style="border: 1px solid #a89078; border-radius: 10px; overflow: hidden; background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 246, 243, 0.95) 100%); box-shadow: 0 2px 8px rgba(168, 144, 120, 0.15); direction:ltr;">`;
                    
                    // رأس أيام الأسبوع
                html += `<div style="display:grid; grid-template-columns: repeat(7, 1fr); gap: ${gridGap}px; padding: 12px; text-align:center; font-size: ${isMobile? '13px':'14px'}; color:white; background: linear-gradient(135deg, #a89078 0%, #8b7765 100%); font-weight: 700; border-bottom: 2px solid #8b7765; direction:ltr;">`;
                    weekDays.forEach(d => { html += `<div>${d}</div>`; });
                    html += `</div>`;
                    
                    // شبكة الأيام
                html += `<div style="display:grid; grid-template-columns: repeat(7, 1fr); gap: ${gridGap}px; padding: 12px; direction:ltr;">`;
                
                // الأيام الفارغة في بداية الشهر
                    for (let i = 0; i < firstDay; i++) {
                    html += `<div style="height: ${cellMinHeight}px;"></div>`;
                    }
                
                // الأيام
                    for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const event = eventMap.get(dateStr);
                    const isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                        
                    let cellStyle = 'min-height: ' + cellMinHeight + 'px; border: 1px solid #a89078; border-radius: 10px; background: linear-gradient(135deg, rgba(168, 144, 120, 0.05) 0%, rgba(139, 119, 101, 0.03) 100%); display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: ' + padXY + '; gap: 6px; cursor: pointer; transition: all 0.2s;';
                    let dayNumStyle = 'align-self:flex-end; font-weight:800; font-size:' + dayFontSize + 'px; color:#8b7765; line-height:1; padding:2px 4px; border-radius:6px;';
                        let priceHtml = '';
                        let ownerHtml = '';
                        
                        if (event) {
                        // استخدام تدرج الألوان البيج والرمادي مثل باقي الموقع
                        cellStyle = 'min-height: ' + cellMinHeight + 'px; border: 2px solid #a89078; background: linear-gradient(135deg, rgba(168, 144, 120, 0.25) 0%, rgba(139, 119, 101, 0.2) 100%); color:#8b7765; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: ' + padXY + '; gap: 6px; cursor: default;';
                        dayNumStyle = 'align-self:flex-end; font-weight:900; font-size:' + dayFontSize + 'px; color:#8b7765; line-height:1; padding:2px 4px; border-radius:6px; background: rgba(168,144,120,0.15)';
                        const isOwn = !!event.is_user_booking;
                            const statusText = event.is_owner_booking ? 'محجوز من المالك' : 'محجوز';
                        // عرض السعر بدون أقواس - فقط الأرقام مع فاصلات
                        let priceDisplay = '';
                        if (event.price != null) {
                            // إزالة جميع أنواع الأقواس من الرقم بشكل شامل ومؤكد
                            let priceValue = String(event.price);
                            // إزالة جميع أنواع الأقواس: معقوفة {}، عادية ()، مربعة []، زاوية <>
                            priceValue = priceValue.replace(/[{}()[\]<>]/g, '');
                            // إزالة أي مسافات أو أحرف غير مرغوبة
                            priceValue = priceValue.trim();
                            // إزالة أي أحرف غير رقمية ما عدا النقطة والفاصلة
                            priceValue = priceValue.replace(/[^0-9.,]/g, '');
                            // تحويل إلى رقم ثم تنسيقه بدون أقواس
                            const numPrice = parseFloat(priceValue.replace(/,/g, ''));
                            if (!isNaN(numPrice)) {
                                // تنسيق الرقم وإزالة جميع الأقواس بعد التنسيق
                                let formatted = numPrice.toLocaleString('ar-EG');
                                // إزالة جميع أنواع الأقواس من النص المنسق
                                formatted = formatted.replace(/[{}()[\]<>]/g, '');
                                priceDisplay = formatted + ' ر.س';
                            } else {
                                priceDisplay = statusText;
                            }
                        } else {
                            priceDisplay = statusText;
                        }
                        priceHtml = `<div style="font-size:11px; line-height:1.2; font-weight:700; color:#8b7765; background: linear-gradient(135deg, rgba(168, 144, 120, 0.3) 0%, rgba(139, 119, 101, 0.25) 100%); border:1px solid #a89078; border-radius:6px; padding:3px 8px; white-space: nowrap;">${priceDisplay}</div>`;
                        if (event.is_owner_booking && event.price == null) {
                            ownerHtml = `<div style="font-size:10px; line-height:1.2; color:#8b7765; font-weight:600;">${statusText}</div>`;
                        }
                    } else if (isToday) {
                        cellStyle = 'min-height: ' + cellMinHeight + 'px; border: 2px solid #a89078; background: linear-gradient(135deg, rgba(168, 144, 120, 0.2) 0%, rgba(139, 119, 101, 0.2) 100%); color:#8b7765; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: ' + padXY + '; gap: 6px; cursor: pointer; transition: all 0.2s;';
                        dayNumStyle = 'align-self:flex-end; font-weight:900; font-size:' + dayFontSize + 'px; color:#8b7765; line-height:1; padding:2px 4px; border-radius:6px; background: rgba(168,144,120,0.15)';
                    } else {
                        cellStyle += ' hover:border-beige hover:bg-cream';
                    }
                    
                    const classes = event ? ('cal-day booked' + (event.is_user_booking ? ' own' : '')) : 'cal-day available';
                    // عرض رقم اليوم بدون أي أقواس - تنظيف شامل ومؤكد
                    let dayNumber = String(day);
                    // إزالة جميع أنواع الأقواس بشكل شامل: معقوفة {}، عادية ()، مربعة []
                    dayNumber = dayNumber.replace(/\{/g, '').replace(/\}/g, '').replace(/\(/g, '').replace(/\)/g, '').replace(/\[/g, '').replace(/\]/g, '').replace(/</g, '').replace(/>/g, '');
                    // إزالة أي مسافات أو أحرف غير مرغوبة
                    dayNumber = dayNumber.trim();
                    // التأكد من أن الرقم هو رقم فقط بدون أي رموز
                    dayNumber = dayNumber.replace(/[^0-9]/g, '');
                    // إذا كان الرقم فارغاً بعد التنظيف، استخدم الرقم الأصلي
                    if (!dayNumber || dayNumber === '') {
                        dayNumber = String(day);
                    }
                    // تنظيف نهائي من أي أقواس متبقية - مؤكد 100%
                    dayNumber = dayNumber.replace(/[{}()[\]<>]/g, '');
                    // بناء HTML للخلية
                    html += '<div class="' + classes + '" data-date="' + dateStr + '" style="' + cellStyle + '"><div style="' + dayNumStyle + '">' + dayNumber + '</div>' + priceHtml + ownerHtml + '</div>';
                    }
                    html += `</div>`; // end days grid
                    html += `</div>`; // end month card
                
                // مفتاح ألوان (تدرج البيج والرمادي)
                html += `
                    <div style="margin-top: 20px; display:flex; gap:16px; flex-wrap:wrap; justify-content:center; font-size: 13px;">
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background: linear-gradient(135deg, rgba(168, 144, 120, 0.2) 0%, rgba(139, 119, 101, 0.2) 100%); border:2px solid #a89078; border-radius:4px;"></span><span>اليوم</span></div>
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background: linear-gradient(135deg, rgba(168, 144, 120, 0.25) 0%, rgba(139, 119, 101, 0.2) 100%); border:2px solid #a89078; border-radius:4px;"></span><span>محجوز</span></div>
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background: linear-gradient(135deg, rgba(168, 144, 120, 0.05) 0%, rgba(139, 119, 101, 0.03) 100%); border:1px solid #a89078; border-radius:4px;"></span><span>متاح</span></div>
                    </div>
                `;
                
                container.innerHTML = html;

                // إضافة مستمعي الأحداث لأزرار التنقل
                document.getElementById('prevMonthBtn').addEventListener('click', function() {
                    currentDisplayMonth = prevMonth;
                    currentDisplayYear = prevYear;
                    renderCalendarMonth();
                });

                document.getElementById('nextMonthBtn').addEventListener('click', function() {
                    currentDisplayMonth = nextMonth;
                    currentDisplayYear = nextYear;
                    renderCalendarMonth();
                });

                // زر العودة إلى الشهر الحالي
                const goToTodayBtn = document.getElementById('goToTodayBtn');
                if (goToTodayBtn) {
                    goToTodayBtn.addEventListener('click', function() {
                        const today = new Date();
                        currentDisplayMonth = today.getMonth();
                        currentDisplayYear = today.getFullYear();
                        renderCalendarMonth();
                    });
                }

                // تمكين الحجز بنقرة على الأيام المتاحة
                const availableDays = container.querySelectorAll('.cal-day.available');
                availableDays.forEach(el => {
                    el.addEventListener('click', () => {
                        const dateStr = el.getAttribute('data-date');
                        // تحذير أيام الذروة (خميس/جمعة/سبت)
                        const d = new Date(dateStr);
                        const weekday = d.getDay(); // 0=الأحد
                        const isPeak = (weekday === 4 || weekday === 5 || weekday === 6);
                        if (isPeak) {
                            const ok = confirm(`تنبيه: هذا موعد ذروة (خميس/جمعة/سبت) وقد يؤثر حجزك على الأرباح.\nهل تريد المتابعة لحجز يوم ${dateStr}؟`);
                            if (!ok) return;
                        } else {
                            if (!confirm(`تأكيد حجز يوم ${dateStr}؟`)) return;
                        }
                        createBooking(dateStr);
                    });
                });

                // تمكين إلغاء الحجز بنقرة على الأيام المحجوزة (للصلاحيات المسموح بها فقط - يتحقق السيرفر)
                const bookedDays = container.querySelectorAll('.cal-day.booked');
                bookedDays.forEach(el => {
                    el.addEventListener('click', () => {
                        const isOwn = el.classList.contains('own');
                        if (!(isOwn || isOwnerForCurrentUnit || isStaff)) {
                            return; // ليس لديه صلاحية الإلغاء
                        }
                        const dateStr = el.getAttribute('data-date');
                        if (!confirm(`هل تريد إلغاء الحجز ليوم ${dateStr}؟`)) return;
                        // استدعاء API الإلغاء - سيعيد 403 إذا لم تكن لديك صلاحية
                        fetch(`/api/unit/${currentUnitId}/bookings/cancel/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken') || ''
                            },
                            body: JSON.stringify({ date: dateStr })
                        }).then(r => r.json().then(data => ({ ok: r.ok, status: r.status, data })))
                          .then(res => {
                              if (res.ok) {
                                  // تحديث التقويم بعد الإلغاء
                                  fetch(`/api/unit/${currentUnitId}/bookings/`)
                                      .then(r => r.json())
                                      .then(d => {
                                          displayCalendar(d.events);
                                      });
                              } else {
                                  const msg = res.data && res.data.error ? res.data.error : `تعذر إلغاء الحجز (رمز ${res.status})`;
                                  alert(msg);
                              }
                          })
                          .catch(() => alert('تعذر إلغاء الحجز'));
                    });
                });
            }

            // إعادة ضبط المقاسات عند تغيير حجم الشاشة
            window.addEventListener('resize', () => {
                const newIsMobile = window.innerWidth <= 576;
                if (newIsMobile !== isMobile) {
                    isMobile = newIsMobile;
                    // إعادة الرسم بنفس الشهر الحالي
                    renderCalendarMonth();
                }
            });

            // CSRF helper
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function createBooking(dateStr) {
                if (!currentUnitId) return;
                fetch(`/api/unit/${currentUnitId}/bookings/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    body: JSON.stringify({ date: dateStr })
                }).then(r => r.json())
                  .then(res => {
                      if (res && res.ok) {
                          // تحديث التقويم
                          fetch(`/api/unit/${currentUnitId}/bookings/`)
                              .then(r => r.json())
                              .then(d => {
                                  displayCalendar(d.events);
                              });
                      } else {
                          alert(res.error || 'تعذر إنشاء الحجز');
                      }
                  })
                  .catch(() => alert('تعذر إنشاء الحجز'));
            }
        });
    </script>
</body>
</html>
<!--
                    const isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                    
                    let cellStyle = 'min-height: 60px; border: 1px solid #e5e7eb; border-radius: 10px; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: 6px 8px; gap: 4px; cursor: pointer; transition: all 0.2s;';
                    let dayStyle = 'font-weight:700; font-size:14px; color:#0f172a; line-height:1;';
                    let priceHtml = '';
                    let ownerHtml = '';
                    
                    if (event) {
                        cellStyle = 'min-height: 60px; border: 2px solid #636e72; background: linear-gradient(135deg, rgba(99, 110, 114, 0.15) 0%, rgba(45, 52, 54, 0.1) 100%); color:#2d3748; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: 6px 8px; gap: 4px; cursor: default;';
                        dayStyle = 'font-weight:800; font-size:14px; color:#1a365d;';
                        const statusText = event.is_owner_booking ? 'محجوز من المالك' : 'محجوز';
                        const priceText = (event.price != null) ? `${Number(event.price).toLocaleString('ar-EG')} ر.س` : statusText;
                        priceHtml = `<div style="font-size:11px; line-height:1.2; font-weight:700; color:#1a365d; background: linear-gradient(135deg, rgba(168, 144, 120, 0.2) 0%, rgba(139, 119, 101, 0.2) 100%); border:1px solid #a89078; border-radius:6px; padding:3px 8px; white-space: nowrap;">${priceText}</div>`;
                        if (event.is_owner_booking && event.price == null) {
                            ownerHtml = `<div style="font-size:10px; line-height:1.2; color:#636e72; font-weight:600;">${statusText}</div>`;
                        }
                    } else if (isToday) {
                        cellStyle = 'min-height: 60px; border: 2px solid #a89078; background: linear-gradient(135deg, rgba(168, 144, 120, 0.2) 0%, rgba(139, 119, 101, 0.2) 100%); color:#8b7765; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding: 6px 8px; gap: 4px; cursor: pointer; transition: all 0.2s;';
                        dayStyle = 'font-weight:900; font-size:14px;';
                    } else {
                        cellStyle += ' hover:border-beige hover:bg-cream';
                    }
                    
                    const classes = event ? 'cal-day booked' : 'cal-day available';
                    html += `<div class="${classes}" data-date="${dateStr}" style="${cellStyle}" onmouseover="if(!this.classList.contains('booked')) {this.style.border='2px solid #a89078'; this.style.background='linear-gradient(135deg, rgba(168, 144, 120, 0.15) 0%, rgba(139, 119, 101, 0.15) 100%)'}" onmouseout="if(!this.classList.contains('booked') && !this.style.color.includes('8b7765')) {this.style.border='1px solid #e5e7eb'; this.style.background='#fff'}"><div style="${dayStyle}">${day}</div>${priceHtml}${ownerHtml}}</div>`;
                }
                html += `</div>`; // end days grid
                html += `</div>`; // end month card
                
                // مفتاح ألوان
                html += `
                    <div style="margin-top: 20px; display:flex; gap:16px; flex-wrap:wrap; justify-content:center; font-size: 13px;">
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background: linear-gradient(135deg, rgba(168, 144, 120, 0.2) 0%, rgba(139, 119, 101, 0.2) 100%); border:2px solid #a89078; border-radius:4px;"></span><span>اليوم</span></div>
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background: linear-gradient(135deg, rgba(99, 110, 114, 0.15) 0%, rgba(45, 52, 54, 0.1) 100%); border:2px solid #636e72; border-radius:4px;"></span><span>محجوز</span></div>
                        <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block; width:18px; height:18px; background:#fff; border:1px solid #e5e7eb; border-radius:4px;"></span><span>متاح</span></div>
                    </div>
                `;
                
                container.innerHTML = html;

                // إضافة مستمعي الأحداث لأزرار التنقل
                document.getElementById('prevMonthBtn').addEventListener('click', function() {
                    currentDisplayMonth = prevMonth;
                    currentDisplayYear = prevYear;
                    renderCalendarMonth();
                });

                document.getElementById('nextMonthBtn').addEventListener('click', function() {
                    currentDisplayMonth = nextMonth;
                    currentDisplayYear = nextYear;
                    renderCalendarMonth();
                });

                // زر العودة إلى الشهر الحالي
                const goToTodayBtn = document.getElementById('goToTodayBtn');
                if (goToTodayBtn) {
                    goToTodayBtn.addEventListener('click', function() {
                        const today = new Date();
                        currentDisplayMonth = today.getMonth();
                        currentDisplayYear = today.getFullYear();
                        renderCalendarMonth();
                    });
                }

                // تمكين الحجز بنقرة على الأيام المتاحة
                const availableDays = container.querySelectorAll('.cal-day.available');
                availableDays.forEach(el => {
                    el.addEventListener('click', () => {
                        const dateStr = el.getAttribute('data-date');
                        // تحذير أيام الذروة (خميس/جمعة/سبت)
                        const d = new Date(dateStr);
                        const weekday = d.getDay(); // 0=الأحد
                        const isPeak = (weekday === 4 || weekday === 5 || weekday === 6);
                        if (isPeak) {
                            const ok = confirm(`تنبيه: هذا موعد ذروة (خميس/جمعة/سبت) وقد يؤثر حجزك على الأرباح.\nهل تريد المتابعة لحجز يوم ${dateStr}؟`);
                            if (!ok) return;
                        } else {
                            if (!confirm(`تأكيد حجز يوم ${dateStr}؟`)) return;
                        }
                        createBooking(dateStr);
                    });
                });
            }

            // CSRF helper
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function createBooking(dateStr) {
                if (!currentUnitId) return;
                fetch(`/api/unit/${currentUnitId}/bookings/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    body: JSON.stringify({ date: dateStr })
                }).then(r => r.json())
                  .then(res => {
                      if (res && res.ok) {
                          // تحديث التقويم
                          fetch(`/api/unit/${currentUnitId}/bookings/`)
                              .then(r => r.json())
                              .then(d => {
                                  displayCalendar(d.events);
                                  // الحفاظ على الشهر الحالي المعروض عند التحديث
                              });
                      } else {
                          alert(res.error || 'تعذر إنشاء الحجز');
                      }
                  })
                  .catch(() => alert('تعذر إنشاء الحجز'));
            }
        });
    </script>
</body>
</html>        </div>
    </div>
    
    <!-- Calendar Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const unitCards = document.querySelectorAll('.unit-card[data-unit-id]');
            const modal = new bootstrap.Modal(document.getElementById('unitModal'));
            
            unitCards.forEach(card => {
                card.addEventListener('click', function() {
                    const unitId = this.dataset.unitId;
                    const unitName = this.querySelector('h5').textContent;
                    
                    document.getElementById('unitModalLabel').textContent = `تقويم الحجوزات - ${unitName}`;
                    
                    // جلب بيانات الحجوزات
                    fetch(`/api/unit/${unitId}/bookings/`)
                        .then(response => response.json())
                        .then(data => {
                            displayCalendar(data.events);
                            modal.show();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('حدث خطأ في تحميل البيانات');
                        });
                });
            });

            function displayCalendar(events) {
                const container = document.getElementById('calendar-container');
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // إنشاء تقويم بسيط
                let html = '<div class="calendar-wrapper" style="width: 100%; overflow-x: auto;"><div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; min-width: 280px;">';
                
                // أيام الأسبوع
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                days.forEach(day => {
                    html += `<div style="font-weight: bold; padding: 6px 2px; background: #f5f6fa; border-radius: 5px; font-size: clamp(0.7rem, 2vw, 0.9rem);">${day}</div>`;
                });
                
                // حساب عدد الأيام في الشهر
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                // إضافة خلايا فارغة للأيام قبل بداية الشهر
                for (let i = 0; i < firstDay; i++) {
                    html += '<div style="min-height: 35px;"></div>';
                }
                
                // إضافة أيام الشهر
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isBooked = events.some(event => event.date === dateStr);
                    const isToday = day === today.getDate();
                    
                    let style = 'padding: 8px 4px; border-radius: 6px; border: 2px solid #e0e0e0; min-height: 35px; display: flex; align-items: center; justify-content: center; font-size: clamp(0.75rem, 2vw, 0.95rem);';
                    if (isBooked) {
                        style += 'background: #dc3545; color: white; font-weight: bold;';
                    } else if (isToday) {
                        style += 'background: #28a745; color: white; font-weight: bold;';
                    } else {
                        style += 'background: white;';
                    }
                    
                    html += `<div style="${style}">${day}</div>`;
                }
                
                html += '</div></div>';
                
                // إضافة مفتاح الألوان
                html += `
                    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: clamp(0.8rem, 2vw, 0.95rem);">
                        <div style="display: flex; align-items: center; gap: 5px;"><span style="display: inline-block; width: 18px; height: 18px; background: #28a745; border-radius: 3px;"></span> <span>اليوم</span></div>
                        <div style="display: flex; align-items: center; gap: 5px;"><span style="display: inline-block; width: 18px; height: 18px; background: #dc3545; border-radius: 3px;"></span> <span>محجوز</span></div>
                        <div style="display: flex; align-items: center; gap: 5px;"><span style="display: inline-block; width: 18px; height: 18px; background: white; border: 2px solid #e0e0e0; border-radius: 3px;"></span> <span>متاح</span></div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
        });
    </script>
</body>
</html>
-->





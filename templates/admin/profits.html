{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}الأرباح - {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    body {
        font-family: 'Cairo', sans-serif;
        background: #f5f5f5;
    }
    .profits-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .profit-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .profit-header {
        background: linear-gradient(135deg, #a89078 0%, #8b7765 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .profit-badge {
        background: linear-gradient(135deg, #a89078 0%, #8b7765 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        display: inline-block;
    }
    table {
        width: 100%;
    }
    table th {
        background: linear-gradient(135deg, #a89078 0%, #8b7765 100%);
        color: white;
        padding: 12px;
        text-align: center;
    }
    table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
    }
    table tr:hover {
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="profits-container">
    <div class="profit-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;"><i class="fas fa-chart-line"></i> الأرباح والإحصائيات</h1>
            <a href="{% url 'admin_profits_pdf' %}" class="btn btn-light" style="background: white; color: #8b7765; border: 2px solid white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-file-pdf"></i> تصدير PDF
            </a>
        </div>
    </div>

    <!-- جدول الأرباح -->
    <div class="profit-card">
        <h3 class="mb-4"><i class="fas fa-money-bill-wave"></i> الأرباح حسب الوحدة</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>الوحدة</th>
                        <th>المالك (المستثمر)</th>
                        <th>إجمالي الحجوزات</th>
                        <th>إجمالي المصروفات</th>
                        <th>الصافي</th>
                        <th>نسبة الأرباح</th>
                        <th>الأرباح</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in profits_data %}
                    <tr>
                        <td><strong>{{ data.unit.name }}</strong></td>
                        <td>{{ data.owner.username|default:"-" }}</td>
                        <td>{{ data.total_bookings|floatformat:2 }} ر.س</td>
                        <td>{{ data.total_expenses|floatformat:2 }} ر.س</td>
                        <td>{{ data.net_total|floatformat:2 }} ر.س</td>
                        <td><span class="profit-badge">{{ data.percentage }}%</span></td>
                        <td><strong style="color: #28a745; font-size: 1.1em;">{{ data.profit|floatformat:2 }} ر.س</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">لا توجد بيانات</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- رسوم بيانية للحجوزات -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="mb-3"><i class="fas fa-calendar-check"></i> أعلى الوحدات بالحجوزات - الشهر الحالي</h4>
                <canvas id="monthlyBookingsChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="mb-3"><i class="fas fa-calendar-alt"></i> أعلى الوحدات بالحجوزات - السنة الحالية</h4>
                <canvas id="yearlyBookingsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- رسوم بيانية للمصروفات -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="mb-3"><i class="fas fa-receipt"></i> أعلى الوحدات في المصروفات - الشهر الحالي</h4>
                <canvas id="monthlyExpensesChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="mb-3"><i class="fas fa-file-invoice-dollar"></i> أعلى الوحدات في المصروفات - السنة الحالية</h4>
                <canvas id="yearlyExpensesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // بيانات الحجوزات الشهرية
    const monthlyBookingsLabels = [{% for item in monthly_bookings %}'{{ item.unit__name|escapejs }}'{% if not forloop.last %},{% endif %}{% empty %}'لا توجد بيانات'{% endfor %}];
    const monthlyBookingsValues = [{% for item in monthly_bookings %}{{ item.booking_count|default:0 }}{% if not forloop.last %},{% endif %}{% empty %}0{% endfor %}];

    // بيانات الحجوزات السنوية
    const yearlyBookingsLabels = [{% for item in yearly_bookings %}'{{ item.unit__name|escapejs }}'{% if not forloop.last %},{% endif %}{% empty %}'لا توجد بيانات'{% endfor %}];
    const yearlyBookingsValues = [{% for item in yearly_bookings %}{{ item.booking_count|default:0 }}{% if not forloop.last %},{% endif %}{% empty %}0{% endfor %}];

    // بيانات المصروفات الشهرية
    const monthlyExpensesLabels = [{% for item in monthly_expenses %}'{{ item.unit__name|escapejs }}'{% if not forloop.last %},{% endif %}{% empty %}'لا توجد بيانات'{% endfor %}];
    const monthlyExpensesValues = [{% for item in monthly_expenses %}{{ item.total_expenses|default:0|floatformat:2 }}{% if not forloop.last %},{% endif %}{% empty %}0{% endfor %}];

    // بيانات المصروفات السنوية
    const yearlyExpensesLabels = [{% for item in yearly_expenses %}'{{ item.unit__name|escapejs }}'{% if not forloop.last %},{% endif %}{% empty %}'لا توجد بيانات'{% endfor %}];
    const yearlyExpensesValues = [{% for item in yearly_expenses %}{{ item.total_expenses|default:0|floatformat:2 }}{% if not forloop.last %},{% endif %}{% empty %}0{% endfor %}];

    // رسم بياني للحجوزات الشهرية
    const monthlyBookingsCtx = document.getElementById('monthlyBookingsChart');
    if (monthlyBookingsCtx && monthlyBookingsLabels.length > 0 && monthlyBookingsLabels[0] !== 'لا توجد بيانات') {
        new Chart(monthlyBookingsCtx, {
            type: 'bar',
            data: {
                labels: monthlyBookingsLabels,
                datasets: [{
                    label: 'عدد الحجوزات',
                    data: monthlyBookingsValues,
                    backgroundColor: 'rgba(168, 144, 120, 0.8)',
                    borderColor: 'rgba(139, 119, 101, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // رسم بياني للحجوزات السنوية
    const yearlyBookingsCtx = document.getElementById('yearlyBookingsChart');
    if (yearlyBookingsCtx && yearlyBookingsLabels.length > 0 && yearlyBookingsLabels[0] !== 'لا توجد بيانات') {
        new Chart(yearlyBookingsCtx, {
            type: 'bar',
            data: {
                labels: yearlyBookingsLabels,
                datasets: [{
                    label: 'عدد الحجوزات',
                    data: yearlyBookingsValues,
                    backgroundColor: 'rgba(168, 144, 120, 0.8)',
                    borderColor: 'rgba(139, 119, 101, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // رسم بياني للمصروفات الشهرية
    const monthlyExpensesCtx = document.getElementById('monthlyExpensesChart');
    if (monthlyExpensesCtx && monthlyExpensesLabels.length > 0 && monthlyExpensesLabels[0] !== 'لا توجد بيانات') {
        new Chart(monthlyExpensesCtx, {
            type: 'bar',
            data: {
                labels: monthlyExpensesLabels,
                datasets: [{
                    label: 'المصروفات (ر.س)',
                    data: monthlyExpensesValues,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // رسم بياني للمصروفات السنوية
    const yearlyExpensesCtx = document.getElementById('yearlyExpensesChart');
    if (yearlyExpensesCtx && yearlyExpensesLabels.length > 0 && yearlyExpensesLabels[0] !== 'لا توجد بيانات') {
        new Chart(yearlyExpensesCtx, {
            type: 'bar',
            data: {
                labels: yearlyExpensesLabels,
                datasets: [{
                    label: 'المصروفات (ر.س)',
                    data: yearlyExpensesValues,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

</script>
{% endblock %}

